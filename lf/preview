#!/usr/bin/env bash
# Robust lf preview script using chafa + bat + mediainfo
# Safe with missing/invalid numeric args.

file="$1"
w="$2"
h="$3"
x="$4"
y="$5"

# Fallback sizes if missing or non-numeric
re_num='^[0-9]+$'
if [[ ! $w =~ $re_num ]]; then
  w=$(tput cols 2>/dev/null || echo 80)
fi
if [[ ! $h =~ $re_num ]]; then
  h=$(tput lines 2>/dev/null || echo 24)
fi

# compute chafa size as COLUMNSxROWS string; ensure not zero
chafa_size="${w}x${h}"
if [[ $w -lt 2 || $h -lt 2 ]]; then
  w=80
  h=24
  chafa_size="${w}x${h}"
fi

mime=$(file --dereference --brief --mime-type -- "$file" 2>/dev/null || echo "application/octet-stream")

case "$mime" in
image/*)
  # Prefer chafa; use block symbols and fill for best fidelity
  if command -v chafa >/dev/null 2>&1; then
    # Use --symbols=block and --fill=block. Redirect chafa stderr to /dev/null to hide warnings.
    chafa --symbols=block --fill=block --size "${chafa_size}" "$file" 2>/dev/null || echo "Image: $file"
    exit 0
  else
    echo "chafa not found â€” install chafa"
    exit 1
  fi
  ;;
text/* | */xml | application/json | application/x-subrip)
  if command -v bat >/dev/null 2>&1; then
    bat --color=always --style=numbers --line-range=:500 "$file" 2>/dev/null || sed -n '1,500p' "$file"
  else
    sed -n '1,500p' "$file"
  fi
  exit 0
  ;;
video/* | audio/*)
  if command -v mediainfo >/dev/null 2>&1; then
    mediainfo "$file" 2>/dev/null || file -b "$file"
  else
    file -b "$file"
  fi
  exit 0
  ;;
application/pdf)
  if command -v pdftotext >/dev/null 2>&1; then
    pdftotext -l 10 -nopgbrk -q -- "$file" - 2>/dev/null | fmt -w "$w"
  else
    echo "PDF preview requires poppler-utils (pdftotext)"
  fi
  exit 0
  ;;
application/zip | application/x-rar | application/x-7z-compressed)
  # archive listing (quiet if unzip/unrar/7z missing)
  if command -v unzip >/dev/null 2>&1; then
    unzip -l "$file" 2>/dev/null
  elif command -v 7z >/dev/null 2>&1; then
    7z l "$file" 2>/dev/null
  else
    file -b "$file"
  fi
  exit 0
  ;;
*)
  # fallback: short file stat or head
  if command -v bat >/dev/null 2>&1; then
    bat --color=always --style=numbers --line-range=:200 "$file" 2>/dev/null || head -n 200 "$file"
  else
    head -n 200 "$file"
  fi
  exit 0
  ;;
esac
